{"version":3,"file":"profile.js","sources":["../../../../../src/pagesMember/profile/profile.vue","../../../../../uniPage:/cGFnZXNNZW1iZXJccHJvZmlsZVxwcm9maWxlLnZ1ZQ"],"sourcesContent":["<script setup>\nimport { ref } from 'vue'\nimport { getMemberProfileAPI, putMemberProfileAPI } from '@/services/profile.js'\nimport { useMemberStore } from '@/stores/modules/member.js'\nimport { onLoad } from '@dcloudio/uni-app'\n// 获取屏幕边界到安全区域距离\nconst { safeAreaInsets } = uni.getSystemInfoSync()\n//获取本地用户数据\nconst memberStore = useMemberStore()\n//获取数据\nconst profile = ref({})\nconst getUserData = async () => {\n  const res = await getMemberProfileAPI()\n  profile.value = res.result\n  // #ifdef H5\n  //返回数据没有countyCode 所以需要要在云函数通过fullLocation来获取code字段\n  console.log(profile.value.fullLocation.split(' ')[2])\n  const db = uniCloud.database()\n  //筛查符合的字段\n  db.collection('opendb-city-china')\n    .where({ name: profile.value.fullLocation.split(' ')[2] })\n    .get()\n    .then((res) => {\n      profile.value.countyCode = res.result.data[0].code\n    })\n  // #endif\n}\nonLoad(() => {\n  getUserData()\n})\n\n//修改用户头像\nconst onAvatarChange = () => {\n  // #ifdef MP-WEIXIN\n  //调用用户的照片或者拍照\n  uni.chooseMedia({\n    //文件个数\n    count: 1,\n    mediaType: ['image'],\n    success: (res) => {\n      //本地路径\n      const { tempFilePath } = res.tempFiles[0]\n      uni.uploadFile({\n        url: '/member/profile/avatar',\n        name: 'file', //后端数据字段名\n        filePath: tempFilePath, //新头像\n        success: (res) => {\n          // console.log(res)\n          if (res.statusCode === 200) {\n            const { avatar } = JSON.parse(res.data).result\n            // 当前页面更新头像\n            profile.value.avatar = avatar\n            // 更新 Store 头像\n            memberStore.profile.avatar = avatar\n            uni.showToast({ icon: 'success', title: '更新成功' })\n          } else {\n            uni.showToast({ icon: 'error', title: '出现错误' })\n          }\n        },\n      })\n    },\n  })\n  // #endif\n}\n//修改性别\nconst onGenderChange = (e) => {\n  profile.value.gender = e.detail.value\n}\n//获取当前日期为YYYY-MM-DD格式\nconst nowDate = new Date()\nconst year = nowDate.getFullYear()\nconst month = (nowDate.getMonth() + 1).toString().padStart(2, '0') //月份从0开始 补齐两位格式\nconst day = nowDate.getDay().toString().padStart(2, '0') //补齐两位格式\n//返回正确格式\nconst formatNowDate = `${year}-${month}-${day}`\n\n//修改生日\nconst onBirthdayChange = (e) => {\n  console.log(profile.value)\n  profile.value.birthday = e.detail.value\n}\nlet fullLocationCode = ['', '', '']\n// #ifdef MP-WEIXIN\n//修改地址\nconst onFullLocationChange = (e) => {\n  //修改前端界面\n  profile.value.fullLocation = e.detail.value.join(' ')\n  //提交后端更新\n  fullLocationCode = e.detail.code\n}\n// #endif\n\n//修改地址\n// #ifdef H5\nconst onCitychange = (e) => {\n  const code = e.detail.value.map((v) => v.value)\n  fullLocationCode = code\n}\n// #endif\n\n//点击保存提交表单\nconst onSubmit = async () => {\n  const { nickname, gender, birthday, profession } = profile.value\n  let res = {}\n  console.log(fullLocationCode)\n  //判断是否更改城市 更改了上传code\n  if (fullLocationCode[0]) {\n    res = await putMemberProfileAPI({\n      nickname,\n      gender,\n      birthday,\n      profession,\n      provinceCode: fullLocationCode[0],\n      cityCode: fullLocationCode[1],\n      countyCode: fullLocationCode[2],\n    })\n  } else {\n    res = await putMemberProfileAPI({\n      nickname,\n      gender,\n      birthday,\n      profession,\n    })\n  }\n  memberStore.profile.nickname = res.result.nickname\n  memberStore.profile.profession = res.result.profession\n  uni.showToast({ icon: 'success', title: '更新成功' })\n  setTimeout(() => {\n    uni.navigateBack()\n  }, 500)\n}\n</script>\n\n<template>\n  <view class=\"viewport\">\n    <!-- 导航栏 -->\n    <view class=\"navbar\" :style=\"{ paddingTop: safeAreaInsets?.top + 'px' }\">\n      <navigator open-type=\"navigateBack\" class=\"back icon-left\" hover-class=\"none\"></navigator>\n      <view class=\"title\">个人信息</view>\n    </view>\n    <!-- 头像 -->\n    <view class=\"avatar\">\n      <view class=\"avatar-content\" @tap=\"onAvatarChange\">\n        <image class=\"image\" :src=\"profile.avatar\" mode=\"aspectFill\" />\n        <!-- #ifdef MP-WEIXIN -->\n        <text class=\"text\">点击修改头像</text>\n        <!-- #endif -->\n      </view>\n    </view>\n    <!-- 表单 -->\n    <view class=\"form\">\n      <!-- 表单内容 -->\n      <view class=\"form-content\">\n        <view class=\"form-item\">\n          <text class=\"label\">账号</text>\n          <text class=\"account\">{{ profile.account }}</text>\n        </view>\n        <view class=\"form-item\">\n          <text class=\"label\">昵称</text>\n          <input class=\"input\" type=\"text\" placeholder=\"请填写昵称\" v-model=\"profile.nickname\" />\n        </view>\n        <view class=\"form-item\">\n          <text class=\"label\">性别</text>\n          <radio-group @change=\"onGenderChange\">\n            <label class=\"radio\">\n              <radio value=\"男\" color=\"#27ba9b\" :checked=\"profile.gender === '男'\" />\n              男\n            </label>\n            <label class=\"radio\">\n              <radio value=\"女\" color=\"#27ba9b\" :checked=\"profile.gender === '女'\" />\n              女\n            </label>\n          </radio-group>\n        </view>\n        <view class=\"form-item\">\n          <text class=\"label\">生日</text>\n          <picker\n            class=\"picker\"\n            mode=\"date\"\n            start=\"1900-01-01\"\n            :end=\"formatNowDate\"\n            :value=\"profile.birthday\"\n            @change=\"onBirthdayChange\"\n          >\n            <view v-if=\"profile.birthday\">{{ profile.birthday }}</view>\n            <view class=\"placeholder\" v-else>请选择日期</view>\n          </picker>\n        </view>\n        <!-- #ifdef MP-WEIXIN -->\n        <view class=\"form-item\">\n          <text class=\"label\">城市</text>\n          <picker\n            class=\"picker\"\n            mode=\"region\"\n            :value=\"profile.fullLocation?.split(' ')\"\n            @change=\"onFullLocationChange\"\n          >\n            <view v-if=\"profile.fullLocation\">{{ profile.fullLocation }}</view>\n            <view class=\"placeholder\" v-else>请选择城市</view>\n          </picker>\n        </view>\n        <!-- #endif -->\n        <!-- #ifdef H5 -->\n        <view class=\"form-item\">\n          <text class=\"label\">城市</text>\n          <!-- #ifdef H5 -->\n          <uni-data-picker\n            placeholder=\"请选择地址\"\n            popup-title=\"请选择城市\"\n            collection=\"opendb-city-china\"\n            field=\"code as value, name as text\"\n            orderby=\"value asc\"\n            :step-searh=\"true\"\n            self-field=\"code\"\n            parent-field=\"parent_code\"\n            :clear-icon=\"false\"\n            @change=\"onCitychange\"\n            v-model=\"profile.countyCode\"\n          >\n          </uni-data-picker>\n          <!-- #endif -->\n        </view>\n        <!-- #endif -->\n        <view class=\"form-item\">\n          <text class=\"label\">职业</text>\n          <input class=\"input\" type=\"text\" placeholder=\"请填写职业\" v-model=\"profile.profession\" />\n        </view>\n      </view>\n      <!-- 提交按钮 -->\n      <button class=\"form-button\" @tap=\"onSubmit\">保 存</button>\n    </view>\n  </view>\n</template>\n\n<style lang=\"scss\">\npage {\n  background-color: #f4f4f4;\n}\n\n.viewport {\n  display: flex;\n  flex-direction: column;\n  height: 100%;\n  background-image: url(https://pcapi-xiaotuxian-front-devtest.itheima.net/miniapp/images/order_bg.png);\n  background-size: auto 420rpx;\n  background-repeat: no-repeat;\n}\n\n// 导航栏\n.navbar {\n  position: relative;\n\n  .title {\n    height: 40px;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n    font-size: 16px;\n    font-weight: 500;\n    color: #fff;\n  }\n\n  .back {\n    position: absolute;\n    height: 40px;\n    width: 40px;\n    left: 0;\n    font-size: 20px;\n    color: #fff;\n    display: flex;\n    justify-content: center;\n    align-items: center;\n  }\n}\n\n// 头像\n.avatar {\n  text-align: center;\n  width: 100%;\n  height: 260rpx;\n  display: flex;\n  flex-direction: column;\n  justify-content: center;\n  align-items: center;\n\n  .image {\n    width: 160rpx;\n    height: 160rpx;\n    border-radius: 50%;\n    background-color: #eee;\n  }\n\n  .text {\n    display: block;\n    padding-top: 20rpx;\n    line-height: 1;\n    font-size: 26rpx;\n    color: #fff;\n  }\n}\n\n// 表单\n.form {\n  background-color: #f4f4f4;\n\n  &-content {\n    margin: 20rpx 20rpx 0;\n    padding: 0 20rpx;\n    border-radius: 10rpx;\n    background-color: #fff;\n  }\n\n  &-item {\n    display: flex;\n    height: 96rpx;\n    line-height: 46rpx;\n    padding: 25rpx 10rpx;\n    background-color: #fff;\n    font-size: 28rpx;\n    border-bottom: 1rpx solid #ddd;\n\n    &:last-child {\n      border: none;\n    }\n\n    .label {\n      width: 180rpx;\n      color: #333;\n    }\n\n    .account {\n      color: #666;\n    }\n\n    .input {\n      flex: 1;\n      display: block;\n      height: 46rpx;\n    }\n\n    .radio {\n      margin-right: 20rpx;\n    }\n\n    .picker {\n      flex: 1;\n    }\n    .placeholder {\n      color: #808080;\n    }\n  }\n\n  &-button {\n    height: 80rpx;\n    text-align: center;\n    line-height: 80rpx;\n    margin: 30rpx 20rpx;\n    color: #fff;\n    border-radius: 80rpx;\n    font-size: 30rpx;\n    background-color: #27ba9b;\n  }\n}\n</style>\n","import MiniProgramPage from 'D:/code/uni-rabbit/src/pagesMember/profile/profile.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","useMemberStore","ref","getMemberProfileAPI","onLoad","res","putMemberProfileAPI"],"mappings":";;;;;;;;;AAMA,UAAM,EAAE,eAAc,IAAKA,cAAG,MAAC,kBAAmB;AAElD,UAAM,cAAcC,sBAAAA,eAAgB;AAEpC,UAAM,UAAUC,cAAG,IAAC,EAAE;AACtB,UAAM,cAAc,YAAY;AAC9B,YAAM,MAAM,MAAMC,qCAAqB;AACvC,cAAQ,QAAQ,IAAI;AAAA,IAatB;AACAC,kBAAAA,OAAO,MAAM;AACX,kBAAa;AAAA,IACf,CAAC;AAGD,UAAM,iBAAiB,MAAM;AAG3BJ,oBAAAA,MAAI,YAAY;AAAA;AAAA,QAEd,OAAO;AAAA,QACP,WAAW,CAAC,OAAO;AAAA,QACnB,SAAS,CAAC,QAAQ;AAEhB,gBAAM,EAAE,aAAc,IAAG,IAAI,UAAU,CAAC;AACxCA,wBAAAA,MAAI,WAAW;AAAA,YACb,KAAK;AAAA,YACL,MAAM;AAAA;AAAA,YACN,UAAU;AAAA;AAAA,YACV,SAAS,CAACK,SAAQ;AAEhB,kBAAIA,KAAI,eAAe,KAAK;AAC1B,sBAAM,EAAE,OAAM,IAAK,KAAK,MAAMA,KAAI,IAAI,EAAE;AAExC,wBAAQ,MAAM,SAAS;AAEvB,4BAAY,QAAQ,SAAS;AAC7BL,8BAAG,MAAC,UAAU,EAAE,MAAM,WAAW,OAAO,QAAQ;AAAA,cAC5D,OAAiB;AACLA,8BAAG,MAAC,UAAU,EAAE,MAAM,SAAS,OAAO,QAAQ;AAAA,cAC/C;AAAA,YACF;AAAA,UACT,CAAO;AAAA,QACF;AAAA,MACL,CAAG;AAAA,IAEH;AAEA,UAAM,iBAAiB,CAAC,MAAM;AAC5B,cAAQ,MAAM,SAAS,EAAE,OAAO;AAAA,IAClC;AAEA,UAAM,UAAU,oBAAI,KAAM;AAC1B,UAAM,OAAO,QAAQ,YAAa;AAClC,UAAM,SAAS,QAAQ,aAAa,GAAG,WAAW,SAAS,GAAG,GAAG;AACjE,UAAM,MAAM,QAAQ,OAAQ,EAAC,SAAQ,EAAG,SAAS,GAAG,GAAG;AAEvD,UAAM,gBAAgB,GAAG,IAAI,IAAI,KAAK,IAAI,GAAG;AAG7C,UAAM,mBAAmB,CAAC,MAAM;AAC9B,cAAQ,IAAI,QAAQ,KAAK;AACzB,cAAQ,MAAM,WAAW,EAAE,OAAO;AAAA,IACpC;AACA,QAAI,mBAAmB,CAAC,IAAI,IAAI,EAAE;AAGlC,UAAM,uBAAuB,CAAC,MAAM;AAElC,cAAQ,MAAM,eAAe,EAAE,OAAO,MAAM,KAAK,GAAG;AAEpD,yBAAmB,EAAE,OAAO;AAAA,IAC9B;AAYA,UAAM,WAAW,YAAY;AAC3B,YAAM,EAAE,UAAU,QAAQ,UAAU,WAAU,IAAK,QAAQ;AAC3D,UAAI,MAAM,CAAE;AACZ,cAAQ,IAAI,gBAAgB;AAE5B,UAAI,iBAAiB,CAAC,GAAG;AACvB,cAAM,MAAMM,iBAAAA,oBAAoB;AAAA,UAC9B;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,UACA,cAAc,iBAAiB,CAAC;AAAA,UAChC,UAAU,iBAAiB,CAAC;AAAA,UAC5B,YAAY,iBAAiB,CAAC;AAAA,QACpC,CAAK;AAAA,MACL,OAAS;AACL,cAAM,MAAMA,iBAAAA,oBAAoB;AAAA,UAC9B;AAAA,UACA;AAAA,UACA;AAAA,UACA;AAAA,QACN,CAAK;AAAA,MACF;AACD,kBAAY,QAAQ,WAAW,IAAI,OAAO;AAC1C,kBAAY,QAAQ,aAAa,IAAI,OAAO;AAC5CN,oBAAG,MAAC,UAAU,EAAE,MAAM,WAAW,OAAO,QAAQ;AAChD,iBAAW,MAAM;AACfA,sBAAAA,MAAI,aAAc;AAAA,MACnB,GAAE,GAAG;AAAA,IACR;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;ACjIA,GAAG,WAAW,eAAe;"}